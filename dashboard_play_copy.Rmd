---
title: "Dashboard play"
author: "O.P"
date: "2022-08-23"
output: flexdashboard::flex_dashboard
runtime: shiny
---

```{r}
library(shiny)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(multcompView)
library(plotly)

country_info <- readRDS("country.info.rds")
life_expect_df_2 <- readRDS("life.expect.df.2.RDS")

# Summarize data for the scatter plots
region_mort_tb1 <- country_info %>%
  dplyr::select(country, region, life_expectancy_birth, mortality_rate)


region_mort_tb2 <- region_mort_tb1 %>%
  # Create new column with categorization of life expectancy at birth
  mutate(life_expect_class = ifelse(life_expectancy_birth >= 74.76, "High",
                                  ifelse(life_expectancy_birth >= 70.07, "High-moderate",
                                         ifelse(life_expectancy_birth >= 65.54, "Moderate",
                                                ifelse(life_expectancy_birth >= 59.70, "Low-moderate",
                                                       ifelse(life_expectancy_birth < 59.69, "Low", NA)))))) %>%
  # Filter out NA values
  drop_na(life_expect_class) %>%
  drop_na(mortality_rate)

region_mort_tb2$life_expect_class <- factor(region_mort_tb2$life_expect_class,
                                            levels = c("Low", "Low-moderate", "Moderate","High-moderate","High"))

#region_mort_tb2 <- aggregate(region_mort_tb2$mortality_rate, by = list(life_expect_class = #region_mort_tb2$life_expect_class),FUN = mean)

#region_mort_tb2 <- rename(region_mort_tb2, mortality_mean = x)

life_expect_df <- country_info %>%
  select(country, life_expectancy_birth, mortality_rate) %>%
  # Create new column with categorization of life expectancy at birth
  mutate(life_expect_class = ifelse(life_expectancy_birth >= 74.76, "High",
                                    ifelse(life_expectancy_birth >= 70.07, "High-moderate",
                                           ifelse(life_expectancy_birth >= 65.54, "Moderate",
                                                  ifelse(life_expectancy_birth >= 59.70, "Low-moderate",
                                                         ifelse(life_expectancy_birth < 59.69, "Low", NA)))))) %>%
  # Filter out NA values
  drop_na(life_expect_class) %>%
  drop_na(mortality_rate)

# Make life expectancy classes into factors
life_expect_df$life_expect_class <- factor(life_expect_df$life_expect_class,
                                           levels = c("Low", "Low-moderate", "Moderate", "High-moderate","High"))

levels(life_expect_df$life_expect_class) <- c("Low", "Low_moderate", "Moderate", "High_moderate","High")
le_anova_data <- life_expect_df %>% 
  dplyr::select(life_expect_class, mortality_rate)
le_aov <- aov(mortality_rate ~ life_expect_class,
              data = le_anova_data)
le_tukey_result <- TukeyHSD(le_aov, conf.level = 0.95)
le_tukey_matrix <- as.matrix (le_tukey_result) 
le_tukey_df <- as.data.frame(le_tukey_matrix[1])
cld3 <- multcompLetters4(le_aov, le_tukey_result)

dt3 <- group_by(le_anova_data, life_expect_class) %>%
  summarize(mean_mortality_rate = mean(mortality_rate), standard_error = std.error(mortality_rate)) %>%
  arrange(desc(mean_mortality_rate))

cld3 <- as.data.frame.list(cld3$life_expect_class)
dt3$cld <- cld3$Letters

ui <- shinyUI(fluidPage(
  titlePanel("Change in Mortality Rate Per Change in Life Expectancy in Regions Accross the World"),
  sidebarLayout(
    sidebarPanel(h3("Select Graph"), position="left",
                 helpText("Observe change in COVID-19 mortality rate in regions of the world with the change in life expectancy at birth."),
                 selectInput("graph", label = h5("Select Graph"), 
                             choices = list("Scatter" = 1, "Bar" = 2, "All" = 3), selected = 1)),
    mainPanel(h3("..."),
              plotly::plotlyOutput("plot1"),
              plotly::plotlyOutput("plot2"),
              plotly::plotlyOutput("plot3"),
              position="right")
  )
)
)

server <- shinyServer(function(input, output){
  #if(input$graph == 1) {
    output$plot1 <- renderPlotly({
      ggplotly(ggplot(region_mort_tb1, aes(text = paste("country: ", country), x = life_expectancy_birth, y = mortality_rate)) +
                 geom_point() + facet_wrap(. ~ region, nrow = 2) + 
        labs(y = "COVID-19 Mortality Rate", x = "Life Expectancy at Birth (years)", title = "Relationship Between COVID-19 Mortality Rate and Life Expectancy")) %>% layout(title = list(font = list(size = 15)))
    })
  #} else if (input$graph == 2) {
    output$plot2 <- renderPlotly({
      ggplotly(ggplot(dt3, aes(life_expect_class, mean_mortality_rate)) + 
      geom_bar(stat = "identity", aes(fill = mean_mortality_rate), show.legend = FALSE) +
      geom_errorbar(aes(ymin = mean_mortality_rate - standard_error, ymax = mean_mortality_rate + standard_error), width = 0.2) +
      labs(x = "Life Expectancy at Birth Class", y = "COVID-19 Mortality Rate") +
      #      title = "Multiple Comparisons of Relationship Between Mortality Rate and Life Expectancy Class",
      #      subtitle = "Means not sharing any letter are significantly different at the 5% significance level (Tukey's test)") +
      geom_text(aes(label = cld3$Letters), vjust = -0.5, hjust = -0.5, col = "orange") +
        theme_minimal()) %>%
        layout(title = list(text = paste0("ANOVA Result Showing Multiple Comparisons of Relationship Between", "<br>", "Mortality Rate and Life Expectancy Class",
                                    "<br>",
                                    "<sup>",
                                     "Means not sharing any letter are significantly different at the 5% significance level (Tukey's test)","</sup>"), font = list(size = 15)),  margin = list(l = 50, r = 50, b = 100, t = 100, pad = 4)) 
        
    })
    ##Changed to static bar plot
  #} else {
    output$plot3 <- renderPlotly({ 
      ggplotly(ggplot(region_mort_tb1, aes(text = paste("country: ", country), x=life_expectancy_birth, y=mortality_rate)) + labs(x = "Life Expectancy at Birth Class", y = "COVID-19 Mortality Rate", title = "Relationship Between COVID-19 Mortality Rate and Life Expectancy") + geom_point()) %>% layout(title = list(font = list(size = 15)))
    })
 # }
  
})

shinyApp(ui, server)

```

